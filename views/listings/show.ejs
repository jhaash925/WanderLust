<% layout("/layouts/boilerplate") %>

<script>
  const mapToken = "<%= process.env.MAP_TOKEN %>";
  const listing = JSON.parse('<%- JSON.stringify(listing) %>');
</script>

<body>
  <div class="container-fluid mt-3">
    <!-- Hero Section -->
    <div class="hero-section d-flex align-items-center justify-content-start position-relative">
      <img src="<%= listing.image.url %>" class="hero-img" alt="listing_image">
      <div class="hero-overlay position-absolute bottom-0 start-0 p-4">
        <div class="hero-content text-white">
          <h1 class="hero-title"><%= listing.title %></h1>
          <p class="hero-location"><i class="fas fa-map-marker-alt"></i> <%= listing.location %>, <%= listing.country %></p>
        </div>
      </div>
    </div>

    <!-- Listing Details -->
    <div class="row justify-content-center mt-4">
      <div class="col-12 col-md-8 col-lg-6">
        <div class="card show-card shadow-lg position-relative">
          <div class="card-body p-4">
            <div class="listing-details">
              <div class="detail-item">
                <i class="fas fa-user"></i>
                <span>Owned by: <strong><%= listing.owner.username %></strong></span>
              </div>
              <div class="detail-item">
                <i class="fas fa-info-circle"></i>
                <span><%= listing.description %></span>
              </div>
              <div class="detail-item">
                <i class="fas fa-rupee-sign"></i>
                <span class="price">&#8377; <%= listing.price.toLocaleString("en-IN") %></span>
              </div>
              <% if(currUser && currUser._id.equals(listing.owner._id)) { %>
                <div class="btns d-flex gap-3 mt-3 flex-row">
                  <a href="/listings/<%= listing._id %>/edit" class="btn btn-danger edit-btn flex-fill"><i class="fas fa-edit"></i> Edit</a>
                  <form method="POST" action="/listings/<%=listing._id%>?_method=DELETE" class="flex-fill m-0">
                    <button class="btn btn-danger delete-btn w-100"><i class="fas fa-trash"></i> Delete</button>
                  </form>
                </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Review Form -->
    <% if(currUser) { %>
      <div class="row justify-content-center mt-4">
        <div class="col-12 col-md-8 col-lg-6">
          <div class="card shadow-sm border-0">
            <div class="card-header bg-white border-0 d-flex justify-content-center">
              <h5 class="mb-0 text-dark"><i class="fas fa-star"></i> Leave a Review</h5>
            </div>
            <div class="card-body review-form-body">
              <form action="/listings/<%= listing._id %>/reviews" method="POST" novalidate class="needs-validation d-flex flex-column align-items-center">
                <div class="mb-3 w-100 d-flex flex-column align-items-center">
                  <label for="rating" class="form-label fw-bold text-dark">Rating</label>
                  <fieldset class="starability-slot d-flex justify-content-center">
                    <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked aria-label="No rating." />
                    <input type="radio" id="first-rate1" name="review[rating]" value="1" />
                    <label for="first-rate1" title="Terrible">1 star</label>
                    <input type="radio" id="first-rate2" name="review[rating]" value="2" />
                    <label for="first-rate2" title="Not good">2 stars</label>
                    <input type="radio" id="first-rate3" name="review[rating]" value="3" />
                    <label for="first-rate3" title="Average">3 stars</label>
                    <input type="radio" id="first-rate4" name="review[rating]" value="4" />
                    <label for="first-rate4" title="Very good">4 stars</label>
                    <input type="radio" id="first-rate5" name="review[rating]" value="5" />
                    <label for="first-rate5" title="Amazing">5 stars</label>
                  </fieldset>
                </div>
                <div class="mb-3 w-100 d-flex flex-column align-items-center">
                  <label for="comment" class="form-label fw-bold text-dark">Comments</label>
                  <textarea name="review[comment]" id="comment" rows="4" class="form-control border-dark" style="min-width: 400px; width: 100%;" required placeholder="Share your thoughts..."></textarea>
                  <div class="invalid-feedback">Please add a comment for review</div>
                </div>
                <button class="btn btn-outline-dark d-flex justify-content-center align-items-center py-1 px-3"><i class="fas fa-paper-plane me-2"></i> Submit Review</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    <% } %>

    <!-- Reviews List -->
    <% if(listing.reviews.length > 0){ %>
      <div class="row justify-content-center mt-4">
        <div class="col-12 col-md-8 col-lg-6">
          <div class="reviews-container position-relative">
            <h4 class="text-center mb-4"><i class="fas fa-comments"></i> All Reviews</h4>
        <button id="scroll-left" class="scroll-btn btn btn-outline-secondary position-absolute top-50 start-0 translate-middle-y">
          <i class="fas fa-chevron-left"></i>
        </button>
        <div class="reviews-scroll d-flex justify-content-start gap-3 px-3">
          <% for(let review of listing.reviews){ %>
            <div class="card review-card shadow-sm" style="min-width: 200px; max-width: 200px; flex-shrink: 0;">
              <div class="card-body d-flex flex-column">
                <div class="d-flex align-items-center mb-2">
                  <i class="fas fa-user-circle fa-2x text-primary me-2"></i>
                  <h6 class="card-title mb-0"><%= review.author.username %></h6>
                </div>
                <div class="review-rating mb-2">
                  <p class="starability-result mb-0" data-rating="<%=review.rating%>"></p>
                </div>
                <div class="review-comment flex-grow-1">
                  <p class="card-text"><%=review.comment%></p>
                </div>
                <% if(currUser && currUser._id.equals(review.author._id)) { %>
                  <form action="/listings/<%= listing._id %>/reviews/<%= review._id%>?_method=DELETE" method="POST" class="mt-3">
                    <button class="btn btn-outline-danger btn-sm w-100"><i class="fas fa-trash"></i> Delete</button>
                  </form>
                <% } %>
              </div>
            </div>
          <% } %>
        </div>
        <button id="scroll-right" class="scroll-btn btn btn-outline-secondary position-absolute top-50 end-0 translate-middle-y">
          <i class="fas fa-chevron-right"></i>
        </button>
          </div>
        </div>
      </div>
    <% } %>

    <!-- Map -->
    <div class="row mt-4 mb-4 justify-content-center">
      <div class="col-12 col-md-9 col-lg-7">
        <h3 class="mb-3 text-center text-dark fw-bold"><i class="fas fa-map-marked-alt me-2"></i>Where you'll be</h3>
        <div id="map" class="rounded shadow-sm border border-secondary"></div>
      </div>
    </div>
  </div>

  <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
  <script src="/js/map.js"></script>
  <script src="/js/reviewScroll.js"></script>
</body>
